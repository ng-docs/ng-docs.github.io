{
  "id": "guide/static-query-migration",
  "title": "Static Query Migration Guide",
  "contents": "\n\n\n  <div class=\"github-links\">\n    <a href=\"https://github.com/angular/angular-cn/edit/aio/aio/content/guide/static-query-migration.md?message=docs%3A%20请简述你的修改...\" aria-label=\"提供编辑建议\" title=\"提供编辑建议\"><i class=\"material-icons\" aria-hidden=\"true\" role=\"img\">mode_edit</i></a>\n  </div>\n\n\n<div class=\"content\">\n<h1 id=\"static-query-migration-guide\">Static Query Migration Guide<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#static-query-migration-guide\"><i class=\"material-icons\">link</i></a></h1>\n<p>​\n<strong>Important note for library authors: This migration is especially crucial for library authors to facilitate their users upgrading to version 9 when it becomes available (approx Oct 2019).</strong></p>\n<p>In version 9, the default setting for <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> and <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries is changing in order to fix buggy and surprising behavior in queries (read more about that <a href=\"guide/static-query-migration#what-does-this-flag-mean\">here</a>).</p>\n<p>In preparation for this change, in version 8, we are migrating all applications and libraries to explicitly specify the resolution strategy for <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> and <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries.</p>\n<p>Specifically, this migration adds an explicit \"static\" flag that dictates when that query's results should be assigned.\nAdding this flag will ensure your code works the same way when upgrading to version 9.   </p>\n<p>Before:</p>\n<code-example>\n// <a href=\"api/animations/query\" class=\"code-anchor\">query</a> results sometimes available in `ngOnInit`, sometimes in `ngAfterViewInit` (based on template)\n@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a>('foo') foo: <a href=\"api/core/ElementRef\" class=\"code-anchor\">ElementRef</a>; \n</code-example>\n<p>After:</p>\n<code-example>\n// <a href=\"api/animations/query\" class=\"code-anchor\">query</a> results available in ngOnInit\n@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a>('foo', {<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: true}) foo: <a href=\"api/core/ElementRef\" class=\"code-anchor\">ElementRef</a>; \n\nOR\n\n// <a href=\"api/animations/query\" class=\"code-anchor\">query</a> results available in ngAfterViewInit\n@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a>('foo', {<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: false}) foo: <a href=\"api/core/ElementRef\" class=\"code-anchor\">ElementRef</a>;\n</code-example>\n<p>Starting with version 9, the <code><a href=\"api/upgrade/static\" class=\"code-anchor\">static</a></code> flag will default to false.\nAt that time, any <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: false}</code> flags can be safely removed, and we will have a schematic that will update your code for you.</p>\n<p>Note: this flag only applies to <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> and <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries specifically, as <code>@<a href=\"api/core/ViewChildren\" class=\"code-anchor\">ViewChildren</a></code> and <code>@<a href=\"api/core/ContentChildren\" class=\"code-anchor\">ContentChildren</a></code> queries do not have a concept of static and dynamic (they are always resolved as if they are \"dynamic\").</p>\n<h2 id=\"faq\">FAQ<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#faq\"><i class=\"material-icons\">link</i></a></h2>\n<a id=\"what-to-do-with-todo\"></a>\n<h3 id=\"what-should-i-do-if-i-see-a--todo-add-static-flag--comment-printed-by-the-schematic\">What should I do if I see a <code>/* TODO: add <a href=\"api/upgrade/static\" class=\"code-anchor\">static</a> flag */</code> comment printed by the schematic?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#what-should-i-do-if-i-see-a--todo-add-static-flag--comment-printed-by-the-schematic\"><i class=\"material-icons\">link</i></a></h3>\n<p>If you see this comment, it means that the schematic couldn't statically figure out the correct flag. In this case, you'll have to add the correct flag based on your application's behavior.\nFor more information on how to choose, see the <a href=\"guide/static-query-migration#how-do-i-choose\">next question</a>.</p>\n<a id=\"how-do-i-choose\"></a>\n<h3 id=\"how-do-i-choose-which-static-flag-value-to-use-true-or-false\">How do I choose which <code><a href=\"api/upgrade/static\" class=\"code-anchor\">static</a></code> flag value to use: <code>true</code> or <code>false</code>?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#how-do-i-choose-which-static-flag-value-to-use-true-or-false\"><i class=\"material-icons\">link</i></a></h3>\n<p>In the official API docs, we have always recommended retrieving query results in <a href=\"https://angular.io/api/core/ViewChild#description\"><code>ngAfterViewInit</code> for view queries</a> and <a href=\"https://angular.io/api/core/ContentChild#description\"><code>ngAfterContentInit</code> for content queries</a>.\nThis is because by the time those lifecycle hooks run, change detection has completed for the relevant nodes and we can guarantee that we have collected all the possible query results. </p>\n<p>Most applications will want to use <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: false}</code> for the same reason. This setting will ensure query matches that are dependent on binding resolution (e.g. results inside <code>*<a href=\"api/common/NgIf\" class=\"code-anchor\">ngIf</a></code>s or <code>*<a href=\"api/common/NgForOf\" class=\"code-anchor\">ngFor</a></code>s) will be found by the query. </p>\n<p>There are rarer cases where <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: true}</code> flag might be necessary (see <a href=\"guide/static-query-migration#should-i-use-static-true\">answer here</a>).</p>\n<a id=\"should-i-use-static-true\"></a>\n<h3 id=\"is-there-a-case-where-i-should-use-static-true\">Is there a case where I should use <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: true}</code>?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#is-there-a-case-where-i-should-use-static-true\"><i class=\"material-icons\">link</i></a></h3>\n<p>This option was introduced to support creating embedded views on the fly.\nIf you need access to a <code><a href=\"api/core/TemplateRef\" class=\"code-anchor\">TemplateRef</a></code> in a query to create a view dynamically, you won't be able to do so in <code>ngAfterViewInit</code>.\nChange detection has already run on that view, so creating a new view with the template will cause an <code>ExpressionHasChangedAfterChecked</code> error to be thrown.\nIn this case, you will want to set the <code><a href=\"api/upgrade/static\" class=\"code-anchor\">static</a></code> flag to <code>true</code> and create your view in <code>ngOnInit</code>.\nIn most other cases, the best practice is to use <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: false}</code>.</p>\n<p>However, to facilitate the migration to version 8, you may also want to set the <code><a href=\"api/upgrade/static\" class=\"code-anchor\">static</a></code> flag to <code>true</code> if your component code already depends on the query results being available some time <strong>before</strong> <code>ngAfterViewInit</code> (for view queries) or <code>ngAfterContentInit</code> (for content queries).\nFor example, if your component relies on the query results being populated in the <code>ngOnInit</code> hook or in <code>@<a href=\"api/core/Input\" class=\"code-anchor\">Input</a></code> setters, you will need to either set the flag to <code>true</code> or re-work your component to adjust to later timing. </p>\n<p>Note: Selecting the static option means that query results nested in <code>*<a href=\"api/common/NgIf\" class=\"code-anchor\">ngIf</a></code> or <code>*<a href=\"api/common/NgForOf\" class=\"code-anchor\">ngFor</a></code> will not be found by the query.\nThese results are only retrievable after change detection runs. </p>\n<a id=\"what-does-this-flag-mean\"></a>\n<h3 id=\"what-does-this-flag-mean-and-why-is-it-necessary\">What does this flag mean and why is it necessary?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#what-does-this-flag-mean-and-why-is-it-necessary\"><i class=\"material-icons\">link</i></a></h3>\n<p>The default behavior for queries has historically been undocumented and confusing, and has also commonly led to issues that are difficult to debug.\nIn version 9, we would like to make query behavior more consistent and simple to understand. </p>\n<p>To explain why, first it's important to understand how queries have worked up until now.</p>\n<p>Without the <code><a href=\"api/upgrade/static\" class=\"code-anchor\">static</a></code> flag, the compiler decided when each query would be resolved on a case-by-case basis.\nAll <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code>/<code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries were categorized into one of two buckets at compile time: \"static\" or \"dynamic\".\nThis classification determined when query results would become available to users.</p>\n<ul>\n<li>\n<p><strong>Static queries</strong> were queries where the result could be determined statically because the result didn't depend on runtime values like bindings.\nResults from queries classified as static were available before change detection ran for that view (accessible in <code>ngOnInit</code>).</p>\n</li>\n<li>\n<p><strong>Dynamic queries</strong> were queries where the result could NOT be determined statically because the result depended on runtime values (aka bindings).\nResults from queries classified as dynamic were not available until after change detection ran for that view (accessible in <code>ngAfterContentInit</code> for content queries or <code>ngAfterViewInit</code> for view queries).</p>\n</li>\n</ul>\n<p>For example, let's say we have a component, <code>Comp</code>. Inside it, we have this query:</p>\n<code-example>\n@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a>(Foo) foo: Foo;\n</code-example>\n<p>and this template:</p>\n<code-example>\n&#x3C;div foo>&#x3C;/div>\n</code-example>\n<p>This <code>Foo</code> query would be categorized as static because at compile-time it's known that the <code>Foo</code> instance on the <code>&#x3C;div></code> is the correct result for the query.\nBecause the query result is not dependent on runtime values, we don't have to wait for change detection to run on the template before resolving the query.\nConsequently, results can be made available in <code>ngOnInit</code>.</p>\n<p>Let's say the query is the same, but the component template looks like this:</p>\n<code-example>\n&#x3C;div foo *<a href=\"api/common/NgIf\" class=\"code-anchor\">ngIf</a>=\"showing\">&#x3C;/div>\n</code-example>\n<p>With that template, the query would be categorized as a dynamic query.\nWe would need to know the runtime value of <code>showing</code> before determining what the correct results are for the query.\nAs a result, change detection must run first, and results can only be made available in <code>ngAfterViewInit</code> or a setter for the query property.</p>\n<p>The effect of this implementation is that adding an <code>*<a href=\"api/common/NgIf\" class=\"code-anchor\">ngIf</a></code> or <code>*<a href=\"api/common/NgForOf\" class=\"code-anchor\">ngFor</a></code> anywhere above a query match can change when that query's results become available. </p>\n<p>Keep in mind that these categories only applied to <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> and <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries specifically.\n<code>@<a href=\"api/core/ViewChildren\" class=\"code-anchor\">ViewChildren</a></code> and <code>@<a href=\"api/core/ContentChildren\" class=\"code-anchor\">ContentChildren</a></code> queries did not have a concept of static and dynamic, so they were always resolved as if they were \"dynamic\".</p>\n<p>This strategy of resolving queries at different times based on the location of potential query matches has caused a lot of confusion. Namely: </p>\n<ul>\n<li>\n<p>Sometimes query results are available in <code>ngOnInit</code>, but sometimes they aren't and it's not clear why (see <a href=\"https://github.com/angular/angular/issues/21800\">21800</a> or <a href=\"https://github.com/angular/angular/issues/19872\">19872</a>).</p>\n</li>\n<li>\n<p><code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> queries are resolved at a different time from <code>@<a href=\"api/core/ViewChildren\" class=\"code-anchor\">ViewChildren</a></code> queries, and <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries are resolved at a different time from <code>@<a href=\"api/core/ContentChildren\" class=\"code-anchor\">ContentChildren</a></code> queries.\nIf a user turns a <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> query into a <code>@<a href=\"api/core/ViewChildren\" class=\"code-anchor\">ViewChildren</a></code> query, their code can break suddenly because the timing has shifted.\n</p>\n</li>\n<li>\n<p>Code depending on a query result can suddenly stop working as soon as an <code>*<a href=\"api/common/NgIf\" class=\"code-anchor\">ngIf</a></code> or an <code>*<a href=\"api/common/NgForOf\" class=\"code-anchor\">ngFor</a></code> is added to a template.</p>\n</li>\n<li>\n<p>A <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> query for the same component will resolve at different times in the lifecycle for each usage of the component.\nThis leads to buggy behavior where using a component with <code>*<a href=\"api/common/NgIf\" class=\"code-anchor\">ngIf</a></code> is broken in subtle ways that aren't obvious to the component author.</p>\n</li>\n</ul>\n<p>In version 9, we plan to simplify the behavior so all queries resolve after change detection runs by default.\nThe location of query matches in the template cannot affect when the query result will become available and suddenly break your code, and the default behavior is always the same.\nThis makes the logic more consistent and predictable for users. </p>\n<p>That said, if an application does need query results earlier (for example, the query result is needed to create an embedded view), it's possible to add the <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: true}</code> flag to explicitly ask for static resolution.\nWith this flag, users can indicate that they only care about results that are statically available and the query results will be populated before <code>ngOnInit</code>.</p>\n<a id=\"view-children-and-content-children\"></a>\n<h3 id=\"does-this-change-affect-viewchildren-or-contentchildren-queries\">Does this change affect <code>@<a href=\"api/core/ViewChildren\" class=\"code-anchor\">ViewChildren</a></code> or <code>@<a href=\"api/core/ContentChildren\" class=\"code-anchor\">ContentChildren</a></code> queries?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#does-this-change-affect-viewchildren-or-contentchildren-queries\"><i class=\"material-icons\">link</i></a></h3>\n<p>No, this change only affects <code>@<a href=\"api/core/ViewChild\" class=\"code-anchor\">ViewChild</a></code> and <code>@<a href=\"api/core/ContentChild\" class=\"code-anchor\">ContentChild</a></code> queries specifically.\n<code>@<a href=\"api/core/ViewChildren\" class=\"code-anchor\">ViewChildren</a></code> and <code>@<a href=\"api/core/ContentChildren\" class=\"code-anchor\">ContentChildren</a></code> queries are already \"dynamic\" by default and don't support static resolution.</p>\n<a id=\"why-specify-static-false\"></a>\n<h3 id=\"why-do-i-have-to-specify-static-false-isnt-that-the-default\">​Why do I have to specify <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: false}</code>? Isn't that the default?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#why-do-i-have-to-specify-static-false-isnt-that-the-default\"><i class=\"material-icons\">link</i></a></h3>\n<p>The goal of this migration is to transition apps that aren't yet on version 9 to a query pattern that is compatible with version 9.\nHowever, most applications use libraries, and it's likely that some of these libraries may not be upgraded to version 8 yet (and thus might not have the proper flags).\nSince the application's version of Angular will be used for compilation, if we change the default, the behavior of queries in the library's components will change to the version 8 default and possibly break.\nThis way, an application's dependencies will behave the same way during the transition as they did in the previous version. </p>\n<p>In Angular version 9 and later, it will be safe to remove any <code>{<a href=\"api/upgrade/static\" class=\"code-anchor\">static</a>: false}</code> flags and we will do this cleanup for you in a schematic.</p>\n<a id=\"libraries\"></a>\n<h3 id=\"can-i-keep-on-using-angular-libraries-that-havent-yet-updated-to-version-8-yet\">Can I keep on using Angular libraries that haven’t yet updated to version 8 yet?<a title=\"Link to this heading\" class=\"header-link\" aria-hidden=\"true\" href=\"guide/static-query-migration#can-i-keep-on-using-angular-libraries-that-havent-yet-updated-to-version-8-yet\"><i class=\"material-icons\">link</i></a></h3>\n<p>Yes, absolutely!\nBecause we have not changed the default query behavior in version 8 (i.e. the compiler still chooses a timing if no flag is set), when your application runs with a library that has not updated to version 8, the library will run the same way it did in version 7.\nThis guarantees your app will work in version 8 even if libraries take longer to update their code.  </p>\n\n</div>\n\n<!-- links to this doc:\n-->\n<!-- links from this doc:\n - api/animations/query\n - api/common/NgForOf\n - api/common/NgIf\n - api/core/ContentChild\n - api/core/ContentChildren\n - api/core/ElementRef\n - api/core/Input\n - api/core/TemplateRef\n - api/core/ViewChild\n - api/core/ViewChildren\n - api/upgrade/static\n - guide/static-query-migration#can-i-keep-on-using-angular-libraries-that-havent-yet-updated-to-version-8-yet\n - guide/static-query-migration#does-this-change-affect-viewchildren-or-contentchildren-queries\n - guide/static-query-migration#faq\n - guide/static-query-migration#how-do-i-choose\n - guide/static-query-migration#how-do-i-choose-which-static-flag-value-to-use-true-or-false\n - guide/static-query-migration#is-there-a-case-where-i-should-use-static-true\n - guide/static-query-migration#should-i-use-static-true\n - guide/static-query-migration#static-query-migration-guide\n - guide/static-query-migration#what-does-this-flag-mean\n - guide/static-query-migration#what-does-this-flag-mean-and-why-is-it-necessary\n - guide/static-query-migration#what-should-i-do-if-i-see-a--todo-add-static-flag--comment-printed-by-the-schematic\n - guide/static-query-migration#why-do-i-have-to-specify-static-false-isnt-that-the-default\n - https://angular.io/api/core/ContentChild#description\n - https://angular.io/api/core/ViewChild#description\n - https://github.com/angular/angular-cn/edit/aio/aio/content/guide/static-query-migration.md?message=docs%3A%20请简述你的修改...\n - https://github.com/angular/angular/issues/19872\n - https://github.com/angular/angular/issues/21800\n-->"
}